define(["jquery","../jquery.mobile.core","../navigation/path","../navigation/base","../events/navigate","../navigation/history","../navigation/navigator","../navigation/method","../jquery.mobile.events","../jquery.mobile.support","jquery-plugins/jquery.hashchange","../widgets/page","../transitions/handlers"],function(jQuery){(function($,undefined){$.widget("mobile.pagecontainer",{options:{theme:"a"},initSelector:false,_create:function(){this._trigger("beforecreate");this.setLastScrollEnabled=true;this._on(this.window,{navigate:"_disableRecordScroll",scrollstop:"_delayedRecordScroll"});this._on(this.window,{navigate:"_filterNavigateEvents"});this._on({pagechange:"_afterContentChange"});this.window.one("navigate",$.proxy(function(){this.setLastScrollEnabled=true},this))},_setOptions:function(options){if(options.theme!==undefined&&options.theme!=="none"){this.element.removeClass("ui-overlay-"+this.options.theme).addClass("ui-overlay-"+options.theme)}else if(options.theme!==undefined){this.element.removeClass("ui-overlay-"+this.options.theme)}this._super(options)},_disableRecordScroll:function(){this.setLastScrollEnabled=false},_enableRecordScroll:function(){this.setLastScrollEnabled=true},_afterContentChange:function(){this.setLastScrollEnabled=true;this._off(this.window,"scrollstop");this._on(this.window,{scrollstop:"_delayedRecordScroll"})},_recordScroll:function(){if(!this.setLastScrollEnabled){return}var active=this._getActiveHistory(),currentScroll,minScroll,defaultScroll;if(active){currentScroll=this._getScroll();minScroll=this._getMinScroll();defaultScroll=this._getDefaultScroll();active.lastScroll=currentScroll<minScroll?defaultScroll:currentScroll}},_delayedRecordScroll:function(){setTimeout($.proxy(this,"_recordScroll"),100)},_getScroll:function(){return this.window.scrollTop()},_getMinScroll:function(){return $.mobile.minScrollBack},_getDefaultScroll:function(){return $.mobile.defaultHomeScroll},_filterNavigateEvents:function(e,data){var url;if(e.originalEvent&&e.originalEvent.isDefaultPrevented()){return}url=e.originalEvent.type.indexOf("hashchange")>-1?data.state.hash:data.state.url;if(!url){url=this._getHash()}if(!url||url==="#"||url.indexOf("#"+$.mobile.path.uiStateKey)===0){url=location.href}this._handleNavigate(url,data.state)},_getHash:function(){return $.mobile.path.parseLocation().hash},getActivePage:function(){return this.activePage},_getInitialContent:function(){return $.mobile.firstPage},_getHistory:function(){return $.mobile.navigate.history},_getActiveHistory:function(){return this._getHistory().getActive()},_getDocumentBase:function(){return $.mobile.path.documentBase},back:function(){this.go(-1)},forward:function(){this.go(1)},go:function(steps){if($.mobile.hashListeningEnabled){window.history.go(steps)}else{var activeIndex=$.mobile.navigate.history.activeIndex,index=activeIndex+parseInt(steps,10),url=$.mobile.navigate.history.stack[index].url,direction=steps>=1?"forward":"back";$.mobile.navigate.history.activeIndex=index;$.mobile.navigate.history.previousIndex=activeIndex;this.change(url,{direction:direction,changeHash:false,fromHashChange:true})}},_handleDestination:function(to){var history;if($.type(to)==="string"){to=$.mobile.path.stripHash(to)}if(to){history=this._getHistory();to=!$.mobile.path.isPath(to)?$.mobile.path.makeUrlAbsolute("#"+to,this._getDocumentBase()):to}return to||this._getInitialContent()},_transitionFromHistory:function(direction,defaultTransition){var history=this._getHistory(),entry=direction==="back"?history.getLast():history.getActive();return entry&&entry.transition||defaultTransition},_handleDialog:function(changePageOptions,data){var to,active,activeContent=this.getActivePage();if(activeContent&&!activeContent.data("mobile-dialog")){if(data.direction==="back"){this.back()}else{this.forward()}return false}else{to=data.pageUrl;active=this._getActiveHistory();$.extend(changePageOptions,{role:active.role,transition:this._transitionFromHistory(data.direction,changePageOptions.transition),reverse:data.direction==="back"})}return to},_handleNavigate:function(url,data){var to=$.mobile.path.stripHash(url),history=this._getHistory(),transition=history.stack.length===0?"none":this._transitionFromHistory(data.direction),changePageOptions={changeHash:false,fromHashChange:true,reverse:data.direction==="back"};$.extend(changePageOptions,data,{transition:transition});if(history.activeIndex>0&&to.indexOf($.mobile.dialogHashKey)>-1){to=this._handleDialog(changePageOptions,data);if(to===false){return}}this._changeContent(this._handleDestination(to),changePageOptions)},_changeContent:function(to,opts){$.mobile.changePage(to,opts)},_getBase:function(){return $.mobile.base},_getNs:function(){return $.mobile.ns},_enhance:function(content,role){return content.page({role:role})},_include:function(page,settings){page.appendTo(this.element);this._enhance(page,settings.role);page.page("bindRemove")},_find:function(absUrl){var fileUrl=this._createFileUrl(absUrl),dataUrl=this._createDataUrl(absUrl),page,initialContent=this._getInitialContent();page=this.element.children("[data-"+this._getNs()+"url='"+$.mobile.path.hashToSelector(dataUrl)+"']");if(page.length===0&&dataUrl&&!$.mobile.path.isPath(dataUrl)){page=this.element.children($.mobile.path.hashToSelector("#"+dataUrl)).attr("data-"+this._getNs()+"url",dataUrl).jqmData("url",dataUrl)}if(page.length===0&&$.mobile.path.isFirstPageUrl(fileUrl)&&initialContent&&initialContent.parent().length){page=$(initialContent)}return page},_getLoader:function(){return $.mobile.loading()},_showLoading:function(delay,theme,msg,textonly){if(this._loadMsg){return}this._loadMsg=setTimeout($.proxy(function(){this._getLoader().loader("show",theme,msg,textonly);this._loadMsg=0},this),delay)},_hideLoading:function(){clearTimeout(this._loadMsg);this._loadMsg=0;this._getLoader().loader("hide")},_showError:function(){this._hideLoading();this._showLoading(0,$.mobile.pageLoadErrorMessageTheme,$.mobile.pageLoadErrorMessage,true);setTimeout($.proxy(this,"_hideLoading"),1500)},_parse:function(html,fileUrl){var page,all=$("<div></div>");all.get(0).innerHTML=html;page=all.find(":jqmData(role='page'), :jqmData(role='dialog')").first();if(!page.length){page=$("<div data-"+this._getNs()+"role='page'>"+(html.split(/<\/?body[^>]*>/gim)[1]||"")+"</div>")}page.attr("data-"+this._getNs()+"url",this._createDataUrl(fileUrl)).attr("data-"+this._getNs()+"external-page",true);return page},_setLoadedTitle:function(page,html){var newPageTitle=html.match(/<title[^>]*>([^<]*)/)&&RegExp.$1;if(newPageTitle&&!page.jqmData("title")){newPageTitle=$("<div>"+newPageTitle+"</div>").text();page.jqmData("title",newPageTitle)}},_isRewritableBaseTag:function(){return $.mobile.dynamicBaseEnabled&&!$.support.dynamicBaseTag},_createDataUrl:function(absoluteUrl){return $.mobile.path.convertUrlToDataUrl(absoluteUrl)},_createFileUrl:function(absoluteUrl){return $.mobile.path.getFilePath(absoluteUrl)},_triggerWithDeprecated:function(name,data,page){var deprecatedEvent=$.Event("page"+name),newEvent=$.Event(this.widgetName+name);(page||this.element).trigger(deprecatedEvent,data);this._trigger(name,newEvent,data);return{deprecatedEvent:deprecatedEvent,event:newEvent}},_loadSuccess:function(absUrl,triggerData,settings,deferred){var fileUrl=this._createFileUrl(absUrl);return $.proxy(function(html,textStatus,xhr){var content,pageElemRegex=new RegExp("(<[^>]+\\bdata-"+this._getNs()+"role=[\"']?page[\"']?[^>]*>)"),dataUrlRegex=new RegExp("\\bdata-"+this._getNs()+"url=[\"']?([^\"'>]*)[\"']?");if(pageElemRegex.test(html)&&RegExp.$1&&dataUrlRegex.test(RegExp.$1)&&RegExp.$1){fileUrl=$.mobile.path.getFilePath($("<div>"+RegExp.$1+"</div>").text());fileUrl=this.window[0].encodeURIComponent(fileUrl)}if(settings.prefetch===undefined){this._getBase().set(fileUrl)}content=this._parse(html,fileUrl);this._setLoadedTitle(content,html);triggerData.xhr=xhr;triggerData.textStatus=textStatus;triggerData.page=content;triggerData.content=content;triggerData.toPage=content;if(this._triggerWithDeprecated("load",triggerData).event.isDefaultPrevented()){return}if(this._isRewritableBaseTag()&&content){this._getBase().rewrite(fileUrl,content)}this._include(content,settings);if(settings.showLoadMsg){this._hideLoading()}deferred.resolve(absUrl,settings,content)},this)},_loadDefaults:{type:"get",data:undefined,reloadPage:false,reload:false,role:undefined,showLoadMsg:false,loadMsgDelay:50},load:function(url,options){var deferred=options&&options.deferred||$.Deferred(),reloadOptionExtension=options&&options.reload===undefined&&options.reloadPage!==undefined?{reload:options.reloadPage}:{},settings=$.extend({},this._loadDefaults,options,reloadOptionExtension),content=null,absUrl=$.mobile.path.makeUrlAbsolute(url,this._findBaseWithDefault()),fileUrl,dataUrl,pblEvent,triggerData;if(settings.data&&settings.type==="get"){absUrl=$.mobile.path.addSearchParams(absUrl,settings.data);settings.data=undefined}if(settings.data&&settings.type==="post"){settings.reload=true}fileUrl=this._createFileUrl(absUrl);dataUrl=this._createDataUrl(absUrl);content=this._find(absUrl);if(content.length===0&&$.mobile.path.isEmbeddedPage(fileUrl)&&!$.mobile.path.isFirstPageUrl(fileUrl)){deferred.reject(absUrl,settings);return deferred.promise()}this._getBase().reset();if(content.length&&!settings.reload){this._enhance(content,settings.role);deferred.resolve(absUrl,settings,content);if(!settings.prefetch){this._getBase().set(url)}return deferred.promise()}triggerData={url:url,absUrl:absUrl,toPage:url,prevPage:options?options.fromPage:undefined,dataUrl:dataUrl,deferred:deferred,options:settings};pblEvent=this._triggerWithDeprecated("beforeload",triggerData);if(pblEvent.deprecatedEvent.isDefaultPrevented()||pblEvent.event.isDefaultPrevented()){return deferred.promise()}if(settings.showLoadMsg){this._showLoading(settings.loadMsgDelay)}if(settings.prefetch===undefined){this._getBase().reset()}if(!($.mobile.allowCrossDomainPages||$.mobile.path.isSameDomain($.mobile.path.documentUrl,absUrl))){deferred.reject(absUrl,settings);return deferred.promise()}$.ajax({url:fileUrl,type:settings.type,data:settings.data,contentType:settings.contentType,dataType:"html",success:this._loadSuccess(absUrl,triggerData,settings,deferred),error:this._loadError(absUrl,triggerData,settings,deferred)});return deferred.promise()},_loadError:function(absUrl,triggerData,settings,deferred){return $.proxy(function(xhr,textStatus,errorThrown){this._getBase().set($.mobile.path.get());triggerData.xhr=xhr;triggerData.textStatus=textStatus;triggerData.errorThrown=errorThrown;var plfEvent=this._triggerWithDeprecated("loadfailed",triggerData);if(plfEvent.deprecatedEvent.isDefaultPrevented()||plfEvent.event.isDefaultPrevented()){return}if(settings.showLoadMsg){this._showError()}deferred.reject(absUrl,settings)},this)},_getTransitionHandler:function(transition){transition=$.mobile._maybeDegradeTransition(transition);return $.mobile.transitionHandlers[transition]||$.mobile.defaultTransitionHandler},_triggerCssTransitionEvents:function(to,from,prefix){var samePage=false;prefix=prefix||"";if(from){if(to[0]===from[0]){samePage=true}this._triggerWithDeprecated(prefix+"hide",{nextPage:to,toPage:to,prevPage:from,samePage:samePage},from)}this._triggerWithDeprecated(prefix+"show",{prevPage:from||$(""),toPage:to},to)},_cssTransition:function(to,from,options){var transition=options.transition,reverse=options.reverse,deferred=options.deferred,TransitionHandler,promise;this._triggerCssTransitionEvents(to,from,"before");this._hideLoading();TransitionHandler=this._getTransitionHandler(transition);promise=new TransitionHandler(transition,reverse,to,from).transition();promise.done($.proxy(function(){this._triggerCssTransitionEvents(to,from)},this));promise.done(function(){deferred.resolve.apply(deferred,arguments)})},_releaseTransitionLock:function(){isPageTransitioning=false;if(pageTransitionQueue.length>0){$.mobile.changePage.apply(null,pageTransitionQueue.pop())}},_removeActiveLinkClass:function(force){$.mobile.removeActiveLinkClass(force)},_loadUrl:function(to,triggerData,settings){settings.target=to;settings.deferred=$.Deferred();this.load(to,settings);settings.deferred.done($.proxy(function(url,options,content){isPageTransitioning=false;options.absUrl=triggerData.absUrl;this.transition(content,triggerData,options)},this));settings.deferred.fail($.proxy(function(){this._removeActiveLinkClass(true);this._releaseTransitionLock();this._triggerWithDeprecated("changefailed",triggerData)},this))},_triggerPageBeforeChange:function(to,triggerData,settings){var returnEvents;triggerData.prevPage=this.activePage;$.extend(triggerData,{toPage:to,options:settings});if($.type(to)==="string"){triggerData.absUrl=$.mobile.path.makeUrlAbsolute(to,this._findBaseWithDefault())}else{triggerData.absUrl=settings.absUrl}returnEvents=this._triggerWithDeprecated("beforechange",triggerData);if(returnEvents.event.isDefaultPrevented()||returnEvents.deprecatedEvent.isDefaultPrevented()){return false}return true},change:function(to,options){if(isPageTransitioning){pageTransitionQueue.unshift(arguments);return}var settings=$.extend({},$.mobile.changePage.defaults,options),triggerData={};settings.fromPage=settings.fromPage||this.activePage;if(!this._triggerPageBeforeChange(to,triggerData,settings)){return}to=triggerData.toPage;if($.type(to)==="string"){isPageTransitioning=true;this._loadUrl(to,triggerData,settings)}else{this.transition(to,triggerData,settings)}},transition:function(toPage,triggerData,settings){var fromPage,url,pageUrl,fileUrl,active,activeIsInitialPage,historyDir,pageTitle,isDialog,alreadyThere,newPageTitle,params,cssTransitionDeferred,beforeTransition;if(isPageTransitioning){pageTransitionQueue.unshift([toPage,settings]);return}if(!this._triggerPageBeforeChange(toPage,triggerData,settings)){return}triggerData.prevPage=settings.fromPage;beforeTransition=this._triggerWithDeprecated("beforetransition",triggerData);if(beforeTransition.deprecatedEvent.isDefaultPrevented()||beforeTransition.event.isDefaultPrevented()){return}isPageTransitioning=true;if(toPage[0]===$.mobile.firstPage[0]&&!settings.dataUrl){settings.dataUrl=$.mobile.path.documentUrl.hrefNoHash}fromPage=settings.fromPage;url=settings.dataUrl&&$.mobile.path.convertUrlToDataUrl(settings.dataUrl)||toPage.jqmData("url");pageUrl=url;fileUrl=$.mobile.path.getFilePath(url);active=$.mobile.navigate.history.getActive();activeIsInitialPage=$.mobile.navigate.history.activeIndex===0;historyDir=0;pageTitle=document.title;isDialog=(settings.role==="dialog"||toPage.jqmData("role")==="dialog")&&toPage.jqmData("dialog")!==true;if(fromPage&&fromPage[0]===toPage[0]&&!settings.allowSamePageTransition){isPageTransitioning=false;this._triggerWithDeprecated("transition",triggerData);this._triggerWithDeprecated("change",triggerData);if(settings.fromHashChange){$.mobile.navigate.history.direct({url:url})}return}toPage.page({role:settings.role});if(settings.fromHashChange){historyDir=settings.direction==="back"?-1:1}try{if(document.activeElement&&document.activeElement.nodeName.toLowerCase()!=="body"){$(document.activeElement).blur()}else{$("input:focus, textarea:focus, select:focus").blur()}}catch(e){}alreadyThere=false;if(isDialog&&active){if(active.url&&active.url.indexOf($.mobile.dialogHashKey)>-1&&this.activePage&&!this.activePage.hasClass("ui-dialog")&&$.mobile.navigate.history.activeIndex>0){settings.changeHash=false;alreadyThere=true}url=active.url||"";if(!alreadyThere&&url.indexOf("#")>-1){url+=$.mobile.dialogHashKey}else{url+="#"+$.mobile.dialogHashKey}}newPageTitle=!active?pageTitle:toPage.jqmData("title")||toPage.children(":jqmData(role='header')").find(".ui-title").text();if(!!newPageTitle&&pageTitle===document.title){pageTitle=newPageTitle}if(!toPage.jqmData("title")){toPage.jqmData("title",pageTitle)}settings.transition=settings.transition||(historyDir&&!activeIsInitialPage?active.transition:undefined)||(isDialog?$.mobile.defaultDialogTransition:$.mobile.defaultPageTransition);if(!historyDir&&alreadyThere){$.mobile.navigate.history.getActive().pageUrl=pageUrl}if(url&&!settings.fromHashChange){if(!$.mobile.path.isPath(url)&&url.indexOf("#")<0){url="#"+url}params={transition:settings.transition,title:pageTitle,pageUrl:pageUrl,role:settings.role};if(settings.changeHash!==false&&$.mobile.hashListeningEnabled){$.mobile.navigate(this.window[0].encodeURI(url),params,true)}else if(toPage[0]!==$.mobile.firstPage[0]){$.mobile.navigate.history.add(url,params)}}document.title=pageTitle;$.mobile.activePage=toPage;this.activePage=toPage;settings.reverse=settings.reverse||historyDir<0;cssTransitionDeferred=$.Deferred();this._cssTransition(toPage,fromPage,{transition:settings.transition,reverse:settings.reverse,deferred:cssTransitionDeferred});cssTransitionDeferred.done($.proxy(function(name,reverse,$to,$from,alreadyFocused){$.mobile.removeActiveLinkClass();if(settings.duplicateCachedPage){settings.duplicateCachedPage.remove()}if(!alreadyFocused){$.mobile.focusPage(toPage)}this._releaseTransitionLock();this._triggerWithDeprecated("transition",triggerData);this._triggerWithDeprecated("change",triggerData)},this))},_findBaseWithDefault:function(){var closestBase=this.activePage&&$.mobile.getClosestBaseUrl(this.activePage);return closestBase||$.mobile.path.documentBase.hrefNoHash}});$.mobile.navreadyDeferred=$.Deferred();var pageTransitionQueue=[],isPageTransitioning=false})(jQuery)});