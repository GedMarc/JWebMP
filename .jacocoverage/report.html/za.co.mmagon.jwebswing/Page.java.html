<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>Page.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">JaCoCoverage analysis of project &quot;JWebSwing&quot; (powered by JaCoCo from EclEmma)</a> &gt; <a href="index.source.html" class="el_package">za.co.mmagon.jwebswing</a> &gt; <span class="el_source">Page.java</span></div><h1>Page.java</h1><pre class="source lang-java linenums">/*
 * Copyright (C) 2017 Marc Magon
 *
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with this program.  If not, see &lt;http://www.gnu.org/licenses/&gt;.
 */
package za.co.mmagon.jwebswing;

import com.armineasy.injection.GuiceContext;
import com.fasterxml.jackson.annotation.JsonIgnore;
import java.util.*;
import java.util.List;
import java.util.logging.Level;
import java.util.logging.Logger;
import net.sf.uadetector.*;
import za.co.mmagon.FileTemplates;
import za.co.mmagon.JWebSwingSiteBinder;
import za.co.mmagon.jwebswing.base.ComponentHierarchyBase;
import za.co.mmagon.jwebswing.base.angular.AngularFeature;
import za.co.mmagon.jwebswing.base.client.InternetExplorerCompatibilityMode;
import za.co.mmagon.jwebswing.base.html.*;
import za.co.mmagon.jwebswing.base.html.attributes.ScriptAttributes;
import za.co.mmagon.jwebswing.base.html.interfaces.children.HeadChildren;
import za.co.mmagon.jwebswing.base.references.CSSReference;
import za.co.mmagon.jwebswing.base.references.JavascriptReference;
import za.co.mmagon.jwebswing.base.servlets.enumarations.DevelopmentEnvironments;
import za.co.mmagon.jwebswing.base.servlets.enumarations.RequirementsPriority;
import za.co.mmagon.jwebswing.base.servlets.interfaces.IPage;
import za.co.mmagon.jwebswing.generics.WebReference;
import za.co.mmagon.logger.LogFactory;

/**
 * Top level of any HTML page.
 * &lt;p&gt;
 * Has only two children, head and body.
 * &lt;p&gt;
 * Sometimes scripts are added right at the end but we try to avoid that as much as possible.
 *
 * @author GedMarc
 * @since 24 Apr 2016
 * @version 2.0
 *
 * Replacement of the old page object
 */
public class Page extends Html implements IPage
{

    private static final long serialVersionUID = 1L;

<span class="fc" id="L60">    private static final Logger log = LogFactory.getInstance().getLogger(&quot;Page&quot;);</span>
    /**
     * The options available
     */
    private PageOptions options;
    /**
     * The fields available
     */
    private PageFields fields;

    /**
     * The current user agent of the render
     */
    @JsonIgnore
    private transient ReadableUserAgent userAgent;

    /**
     * The angular feature
     */
    private AngularFeature angular;

    /**
     * Cache for all the associated components throughout the life-cycle of the application
     */
    private transient java.util.Map&lt;String, ComponentHierarchyBase&gt; componentCache;

    /**
     * Populates all my components. Excludes this page
     */
    /**
     * @param title             Sets the title of the page
     * @param compatibilityMode Sets the Internet explorer mode to work on
     * @param base              Sets the base tag for the page. Convenience Parameter
     */
    public Page(Title title, InternetExplorerCompatibilityMode compatibilityMode, Base base)
<span class="fc" id="L95">    {</span>
<span class="fc" id="L96">        getPageFields().setTitle(title);</span>
<span class="fc" id="L97">        getPageFields().setCompatibilityMode(compatibilityMode);</span>
<span class="fc" id="L98">        getPageFields().setBase(base);</span>
<span class="fc" id="L99">        setID(&quot;jwPage&quot;);</span>
        //setGenerator(&quot;JWebSwing - https://sourceforge.net/projects/jwebswing/&quot;);
<span class="fc" id="L101">    }</span>

    /**
     * @param title             Sets the title of the page
     * @param compatibilityMode Sets the Internet explorer mode to work on
     */
    public Page(Title title, InternetExplorerCompatibilityMode compatibilityMode)
    {
<span class="nc" id="L109">        this(title, compatibilityMode, null);</span>
<span class="nc" id="L110">    }</span>

    /**
     * @param title Sets the title of the page
     */
    public Page(Title title)
    {
<span class="nc" id="L117">        this(title, null, null);</span>
<span class="nc" id="L118">    }</span>

    /**
     * @param title Sets the title of the page
     */
    public Page(String title)
    {
<span class="nc" id="L125">        this(new Title(title), null, null);</span>
<span class="nc" id="L126">    }</span>

    /**
     * Constructs an empty page object
     */
    public Page()
    {
<span class="fc" id="L133">        this(null, null, null);</span>
<span class="fc" id="L134">    }</span>

    /**
     * Initializes the page
     */
    public void initialize()
    {

<span class="fc" id="L142">    }</span>

    public &lt;T extends ComponentHierarchyBase&gt; T add(T component)
    {
<span class="nc" id="L146">        return (T) getBody().add(component);</span>
    }

    private boolean initialized;

    /**
     * Renders all the children to a string builder
     *
     * @return
     */
    @Override
    protected StringBuilder renderChildren()
    {
<span class="fc" id="L159">        StringBuilder pageOutput = new StringBuilder();</span>
<span class="fc" id="L160">        StringBuilder bodyOutput = null;</span>

<span class="fc bfc" id="L162" title="All 2 branches covered.">        if (!isBodyEmpty())</span>
        {
<span class="fc" id="L164">            bodyOutput = new StringBuilder(getBody().toString(1));</span>
        }
<span class="fc bfc" id="L166" title="All 2 branches covered.">        if (!isHeadEmpty())</span>
        {
<span class="fc" id="L168">            pageOutput.append(getNewLine()).append(getCurrentTabIndentString()).append(getHead().toString(1));</span>
        }
<span class="fc bfc" id="L170" title="All 2 branches covered.">        if (bodyOutput != null)</span>
        {
<span class="fc" id="L172">            pageOutput.append(getNewLine()).append(getCurrentTabIndentString()).append(bodyOutput);</span>
        }
<span class="fc" id="L174">        return pageOutput;</span>
    }

    @Override
    public void init()
    {
<span class="pc bpc" id="L180" title="1 of 2 branches missed.">        if (!initialized)</span>
        {
<span class="fc" id="L182">            initialize();</span>
<span class="fc" id="L183">            initialized = true;</span>
        }

<span class="pc bpc" id="L186" title="1 of 2 branches missed.">        if (!isInitialized())</span>
        {
<span class="fc" id="L188">            getBody().init();</span>
<span class="fc" id="L189">            getBody().preConfigure();</span>

<span class="fc bfc" id="L191" title="All 2 branches covered.">            if (!GuiceContext.isBuildingInjector())</span>
            {
<span class="pc bpc" id="L193" title="1 of 2 branches missed.">                for (Class&lt;? extends PageConfigurator&gt; next : GuiceContext.reflect().getSubTypesOf(PageConfigurator.class))</span>
                {
<span class="nc" id="L195">                    log.log(Level.CONFIG, &quot;Configuring site for use with configurator [{0}]&quot;, next.getCanonicalName());</span>
<span class="nc" id="L196">                    PageConfigurator configurator = GuiceContext.inject().getInstance(next);</span>
<span class="nc" id="L197">                    configurator.configure(this);</span>
<span class="nc" id="L198">                    log.log(Level.CONFIG, &quot;Configured [{0}]&quot;, next.getCanonicalName());</span>
<span class="nc" id="L199">                }</span>
            }
        }
<span class="fc" id="L202">        super.init();</span>
<span class="fc" id="L203">    }</span>

    /**
     * Configures the page and all its components
     */
    @Override
    public void preConfigure()
    {
<span class="fc bfc" id="L211" title="All 2 branches covered.">        if (!isInitialized())</span>
        {
<span class="fc" id="L213">            init();</span>
        }
<span class="pc bpc" id="L215" title="1 of 2 branches missed.">        if (!isConfigured())</span>
        {
<span class="fc" id="L217">            getBody().init();</span>
<span class="fc" id="L218">            getBody().preConfigure();</span>

<span class="fc" id="L220">            getAngular().preConfigure();</span>

<span class="fc" id="L222">            configurePageHeader();</span>

<span class="fc" id="L224">            addVariablesScriptToPage();</span>

<span class="pc bpc" id="L226" title="1 of 2 branches missed.">            if (!getOptions().isScriptsInHead())</span>
            {
<span class="fc" id="L228">                addScriptsTo(getBody());</span>
            }

<span class="pc bpc" id="L231" title="1 of 2 branches missed.">            if (!getOptions().isScriptsInHead())</span>
            {
<span class="fc" id="L233">                List&lt;Script&gt; allScripts = getDynamicScripts();</span>
<span class="pc bpc" id="L234" title="1 of 2 branches missed.">                allScripts.stream().filter(script -&gt; (script != null)).forEach(getBody()::add);</span>
            }

<span class="fc" id="L237">            getTopShelfScripts().forEach(next -&gt;</span>
            {
<span class="nc" id="L239">                getHead().add((HeadChildren) next);</span>
<span class="nc" id="L240">            });</span>

<span class="fc" id="L242">            ArrayList&lt;ComponentHierarchyBase&gt; requirements = new ArrayList&lt;&gt;();</span>

<span class="fc bfc" id="L244" title="All 2 branches covered.">            for (RequirementsPriority priority : RequirementsPriority.values())</span>
            {
<span class="fc" id="L246">                getPriorityRequirements(priority, requirements, true, false).stream().forEach((comp) -&gt;</span>
                {
<span class="nc" id="L248">                    getHead().getChildren().add(comp);</span>
<span class="nc" id="L249">                });</span>
            }
<span class="fc" id="L251">            getHead().add((HeadChildren) getCssStyle());</span>

<span class="fc" id="L253">            buildComponentHierarchy();</span>
        }
<span class="fc" id="L255">        super.preConfigure();</span>
<span class="fc" id="L256">    }</span>

    /**
     * Returns the component with only it's methods
     *
     * @return
     */
    public IPage asMe()
    {
<span class="nc" id="L265">        return this;</span>
    }

    /**
     * Returns this pages current component cache
     *
     * @return
     */
    @Override
    public java.util.Map&lt;String, ComponentHierarchyBase&gt; getComponentCache()
    {
<span class="fc bfc" id="L276" title="All 2 branches covered.">        if (componentCache == null)</span>
        {
<span class="fc" id="L278">            componentCache = new HashMap&lt;&gt;();</span>
<span class="fc" id="L279">            buildComponentHierarchy();</span>
        }
<span class="fc" id="L281">        return componentCache;</span>
    }

    /**
     * Returns all the components currently associated with this page
     *
     * @return
     */
    @Override
    public List&lt;ComponentHierarchyBase&gt; getAllComponents()
    {
<span class="nc" id="L292">        return (List&lt;ComponentHierarchyBase&gt;) getComponentCache().values();</span>
    }

    /**
     * Builds the component hierarchy from scratch
     */
    public void buildComponentHierarchy()
    {
        //getComponentCache().clear();
<span class="fc" id="L301">        getComponentCache().put(getBody().getID(), getBody());</span>
<span class="fc" id="L302">        buildComponentHierarchy(getBody(), getComponentCache());</span>
<span class="fc" id="L303">    }</span>

    /**
     * Builds up or adds components to the page
     *
     * @param startingPoint The starting component to update with
     * @param addToMap      The map to add to
     */
    public void buildComponentHierarchy(ComponentHierarchyBase startingPoint, java.util.Map&lt;String, ComponentHierarchyBase&gt; addToMap)
    {
<span class="pc bpc" id="L313" title="1 of 2 branches missed.">        startingPoint.getChildren().stream().filter(child -&gt; !(child == null)).map(child</span>
                -&gt;
        {
<span class="fc" id="L316">            ComponentHierarchyBase c = (ComponentHierarchyBase) child;</span>
<span class="fc" id="L317">            addToMap.put(c.getID(), c);</span>
<span class="fc" id="L318">            return child;</span>
<span class="fc" id="L319">        }).forEach(child</span>
                -&gt;
        {
<span class="fc" id="L322">            ComponentHierarchyBase c = (ComponentHierarchyBase) child;</span>
<span class="pc bpc" id="L323" title="1 of 2 branches missed.">            if (child != null)</span>
            {
<span class="fc" id="L325">                buildComponentHierarchy(c, addToMap);</span>
            }
<span class="fc" id="L327">        });</span>
<span class="fc" id="L328">    }</span>

    /**
     * Sets the current component cache
     *
     * @param componentCache
     */
    public void setComponentCache(HashMap&lt;String, ComponentHierarchyBase&gt; componentCache)
    {
<span class="nc" id="L337">        this.componentCache = componentCache;</span>
<span class="nc" id="L338">    }</span>

    /**
     * Returns the style object. If dynamic rendering is enabled it will point to the Servlet.
     *
     * @return
     */
    public ComponentHierarchyBase getCssStyle()
    {
<span class="fc" id="L347">        StringBuilder css = getBody().renderCss(0);</span>
<span class="fc bfc" id="L348" title="All 2 branches covered.">        if (!css.toString().isEmpty())</span>
        {
<span class="pc bpc" id="L350" title="1 of 2 branches missed.">            if (getOptions().isDynamicRender())</span>
            {
<span class="nc" id="L352">                CSSLink renderedCSS = new CSSLink(JWebSwingSiteBinder.getCSSLocation().replaceAll(&quot;/&quot;, &quot;&quot;));</span>
<span class="nc" id="L353">                return renderedCSS;</span>
            }
            else
            {
<span class="pc bpc" id="L357" title="1 of 2 branches missed.">                if (css.length() &gt; 0)</span>
                {
<span class="fc" id="L359">                    Style style = new Style();</span>
<span class="fc" id="L360">                    style.setText(css);</span>
<span class="fc" id="L361">                    return style;</span>
                }
            }
        }
<span class="fc" id="L365">        return null;</span>
    }

    /**
     * Returns the top shelf script and css references
     *
     * @return
     */
    private List&lt;ComponentHierarchyBase&gt; getTopShelfScripts()
    {
        List&lt;ComponentHierarchyBase&gt; arr;
<span class="fc" id="L376">        arr = getPriorityRequirements(RequirementsPriority.Top_Shelf, new ArrayList&lt;&gt;(), true, true);</span>
<span class="fc" id="L377">        return arr;</span>
    }

    /**
     * Returns the script reference
     *
     * @return ArrayList of type script
     */
    private List&lt;Script&gt; getDynamicScripts()
    {
<span class="fc" id="L387">        ArrayList&lt;Script&gt; allScripts = new ArrayList&lt;&gt;();</span>

<span class="fc bfc" id="L389" title="All 2 branches covered.">        if (getOptions().isAngularEnabled())</span>
        {
<span class="pc bpc" id="L391" title="1 of 2 branches missed.">            if (getOptions().isDynamicRender())</span>
            {
<span class="nc" id="L393">                Script dynamicScript = new Script();</span>
<span class="nc" id="L394">                dynamicScript.addAttribute(ScriptAttributes.Type, &quot;application/javascript&quot;);</span>
<span class="nc" id="L395">                dynamicScript.addAttribute(ScriptAttributes.Src, JWebSwingSiteBinder.getAngularScriptLocation().replaceAll(&quot;/&quot;, &quot;&quot;));</span>
                //dynamicScript.setTiny(true);
                //dynamicScript.setText(&quot;$.ajax({cache:false,async:false,dataType:'script',url:'as'}).fail(function(){alert('session lost'); });&quot;);
<span class="nc" id="L398">                allScripts.add(dynamicScript);</span>
<span class="nc" id="L399">            }</span>
            else
            {
<span class="fc" id="L402">                getAngular().configureTemplateVariables();</span>
<span class="fc" id="L403">                StringBuilder js = FileTemplates.renderTemplateScripts(&quot;jwangular&quot;);</span>
<span class="pc bpc" id="L404" title="1 of 2 branches missed.">                if (!js.toString().trim().isEmpty())</span>
                {
<span class="fc" id="L406">                    Script s = new Script();</span>
<span class="fc" id="L407">                    s.addAttribute(ScriptAttributes.Type, &quot;application/javascript&quot;);</span>
<span class="fc" id="L408">                    s.setText(js);</span>
<span class="fc" id="L409">                    allScripts.add(s);</span>
                }
            }
        }

<span class="fc bfc" id="L414" title="All 2 branches covered.">        if (getOptions().isDynamicRender())</span>
        {
<span class="fc" id="L416">            StringBuilder js = renderJavascript();</span>
<span class="pc bpc" id="L417" title="1 of 2 branches missed.">            if (!js.toString().trim().isEmpty())</span>
            {
<span class="nc" id="L419">                Script dynamicScript = new Script();</span>
<span class="nc" id="L420">                dynamicScript.addAttribute(ScriptAttributes.Type, &quot;application/javascript&quot;);</span>
<span class="nc" id="L421">                dynamicScript.addAttribute(ScriptAttributes.Src, JWebSwingSiteBinder.getJavaScriptLocation().replaceAll(&quot;/&quot;, &quot;&quot;));</span>
                //dynamicScript.setTiny(true);
                //dynamicScript.setText(&quot;$.ajax({cache:false,dataType:'script',url:'js'}).fail(function(){alert('session lost'); });&quot;);
<span class="nc" id="L424">                allScripts.add(dynamicScript);</span>
            }
<span class="fc" id="L426">        }</span>
        else
        {
<span class="fc" id="L429">            StringBuilder js = renderJavascript();</span>
<span class="pc bpc" id="L430" title="1 of 2 branches missed.">            if (!js.toString().trim().isEmpty())</span>
            {
<span class="nc" id="L432">                Script s = new Script();</span>
<span class="nc" id="L433">                s.addAttribute(ScriptAttributes.Type, &quot;application/javascript&quot;);</span>
<span class="nc" id="L434">                s.setText(js);</span>
<span class="nc" id="L435">                allScripts.add(s);</span>
            }
        }

<span class="fc" id="L439">        return allScripts;</span>
    }

    /**
     * Builds up the Header Tag
     */
    private void configurePageHeader()
    {
<span class="fc bfc" id="L447" title="All 2 branches covered.">        if (getPageFields().getTitle() != null)</span>
        {
<span class="fc" id="L449">            getHead().add(getPageFields().getTitle());</span>
        }
<span class="fc bfc" id="L451" title="All 2 branches covered.">        if (getPageFields().getBase() != null)</span>
        {
<span class="fc" id="L453">            getHead().add(getPageFields().getBase());</span>
        }
<span class="fc" id="L455">        getHead().add(getPageFields().getHttpEquivMeta());</span>
<span class="fc" id="L456">        getHead().add(getPageFields().getCacheControl());</span>
<span class="fc" id="L457">        getHead().add(getPageFields().getAuthor());</span>
<span class="fc" id="L458">        getHead().add(getPageFields().getApplicationName());</span>
<span class="fc" id="L459">        getHead().add(getPageFields().getGenerator());</span>
<span class="fc" id="L460">        getHead().add(getPageFields().getDescription());</span>
<span class="fc" id="L461">        getHead().add(getPageFields().getKeywords());</span>
<span class="fc" id="L462">        getHead().add(getPageFields().getFavIconLink());</span>

<span class="pc bpc" id="L464" title="1 of 2 branches missed.">        if (getOptions().isScriptsInHead())</span>
        {
<span class="nc" id="L466">            addScriptsTo(getHead());</span>
        }

<span class="pc bpc" id="L469" title="1 of 2 branches missed.">        if (getOptions().isScriptsInHead())</span>
        {
<span class="nc" id="L471">            List&lt;Script&gt; allScripts = getDynamicScripts();</span>
<span class="nc bnc" id="L472" title="All 2 branches missed.">            allScripts.stream().filter(script -&gt; (script != null)).forEach(getHead()::add);</span>
        }

<span class="fc bfc" id="L475" title="All 2 branches covered.">        for (Iterator iterator = getHead().getChildren().iterator(); iterator.hasNext();)</span>
        {
<span class="fc" id="L477">            ComponentHierarchyBase headObject = (ComponentHierarchyBase) iterator.next();</span>
<span class="fc" id="L478">            headObject.preConfigure();</span>
<span class="fc" id="L479">        }</span>
<span class="fc" id="L480">    }</span>

    /**
     * Adds the variables in the application to the collection
     */
    private void addVariablesScriptToPage()
    {
<span class="fc" id="L487">        StringBuilder variablesScriptBuilder = new StringBuilder();</span>
<span class="pc bpc" id="L488" title="1 of 2 branches missed.">        for (Iterator it = getBody().getVariablesAll().iterator(); it.hasNext();)</span>
        {
<span class="nc" id="L490">            String var = (String) it.next();</span>
<span class="nc" id="L491">            variablesScriptBuilder.append(&quot;var &quot;).append(var).append(&quot;;&quot;);</span>
<span class="nc" id="L492">        }</span>
<span class="pc bpc" id="L493" title="1 of 2 branches missed.">        if (variablesScriptBuilder.length() &gt; 0)</span>
        {
<span class="nc" id="L495">            Script variablesScript = new Script();</span>
<span class="nc" id="L496">            variablesScript.setID(&quot;variables&quot;);</span>
<span class="nc" id="L497">            variablesScript.setNewLineForRawText(true);</span>
<span class="nc" id="L498">            variablesScript.addAttribute(ScriptAttributes.Type, &quot;text/javascript&quot;);</span>
<span class="nc" id="L499">            variablesScript.setText(variablesScriptBuilder.toString());</span>
<span class="nc bnc" id="L500" title="All 2 branches missed.">            if (!getHead().getChildren().contains(variablesScript))</span>
            {
<span class="nc" id="L502">                getHead().add(variablesScript);</span>
            }
        }
<span class="fc" id="L505">    }</span>

    private void addScriptsTo(ComponentHierarchyBase component)
    {
<span class="fc" id="L509">        List&lt;ComponentHierarchyBase&gt; requirements = new ArrayList&lt;&gt;();</span>

<span class="fc" id="L511">        List&lt;RequirementsPriority&gt; arrs = new ArrayList&lt;&gt;(Arrays.asList(RequirementsPriority.values()));</span>
        //render JS only
<span class="fc bfc" id="L513" title="All 2 branches covered.">        arrs.stream().filter(a -&gt; a != RequirementsPriority.Top_Shelf).map(priority -&gt;</span>
        {
<span class="pc bpc" id="L515" title="1 of 2 branches missed.">            if (!getPriorityRequirements(priority, requirements, true, false).isEmpty())</span>
            {
<span class="nc bnc" id="L517" title="All 2 branches missed.">                if (getRunningEnvironment().ordinal() &gt;= DevelopmentEnvironments.Development.ordinal())</span>
                {
<span class="nc" id="L519">                    getBody().add(new Comment(&quot;Priority [&quot; + priority + &quot;] Values&quot;));</span>
                }
            }
<span class="fc" id="L522">            return priority;</span>
<span class="fc" id="L523">        }).forEachOrdered(priority -&gt;</span>
        {
<span class="fc" id="L525">            getPriorityRequirements(priority, requirements, false, true).stream().forEach(comp</span>
                    -&gt;
            {
<span class="fc" id="L528">                component.add(comp);</span>
<span class="fc" id="L529">            });</span>
<span class="fc" id="L530">        });</span>
<span class="fc" id="L531">    }</span>

    /**
     * Adds all the stuff for a given priority
     *
     * @param css        CSS
     * @param input      the hierarchy to read from
     * @param priority   the priority
     * @param javascript to return JavaScript or not
     */
    private List&lt;ComponentHierarchyBase&gt; getPriorityRequirements(RequirementsPriority priority, List&lt;ComponentHierarchyBase&gt; input, boolean css, boolean javascript)
    {
<span class="fc" id="L543">        List&lt;ComponentHierarchyBase&gt; requirements = new ArrayList&lt;&gt;();</span>
<span class="fc bfc" id="L544" title="All 2 branches covered.">        if (css)</span>
        {
<span class="pc bnc" id="L546" title="All 4 branches missed.">            getAllCssLinks(priority).stream().filter(cssLink -&gt; (!input.contains(cssLink) &amp;&amp; !requirements.contains(cssLink))).forEach(cssLink</span>
                    -&gt;
            {
<span class="nc" id="L549">                requirements.add(cssLink);</span>
<span class="nc" id="L550">            });</span>
        }
<span class="fc bfc" id="L552" title="All 2 branches covered.">        if (javascript)</span>
        {
<span class="pc bpc" id="L554" title="2 of 4 branches missed.">            getAllScripts(priority).stream().filter(script -&gt; (!input.contains(script) &amp;&amp; !requirements.contains(script))).forEach(script</span>
                    -&gt;
            {
<span class="fc" id="L557">                requirements.add(script);</span>
<span class="fc" id="L558">            });</span>
        }

<span class="fc" id="L561">        return requirements;</span>
    }

    /**
     * Gets all the links for all the bodies components
     *
     * @param priority
     *
     * @return
     */
    private List&lt;CSSLink&gt; getAllCssLinks(RequirementsPriority priority)
    {
<span class="fc" id="L573">        List&lt;CSSReference&gt; allReferences = getBody().getCssReferencesAll(priority);</span>
<span class="fc" id="L574">        allReferences.sort(WebReference.getDummyReference());</span>
<span class="fc" id="L575">        ArrayList&lt;CSSLink&gt; allLinks = new ArrayList&lt;&gt;();</span>
<span class="pc" id="L576">        allReferences.stream().map(ref -&gt; new CSSLink(ref)).forEach(allLinks::add);</span>
<span class="fc" id="L577">        return allLinks;</span>
    }

    /**
     * Gets all the scripts for all the body components
     *
     * @param priority
     *
     * @return
     */
    private List&lt;Script&gt; getAllScripts(RequirementsPriority priority)
    {
<span class="fc" id="L589">        List&lt;JavascriptReference&gt; allJavascripts = getBody().getJavascriptReferencesAll(priority);</span>
<span class="fc" id="L590">        allJavascripts.sort(WebReference.getDummyReference());</span>
<span class="fc" id="L591">        ArrayList&lt;Script&gt; allScripts = new ArrayList&lt;&gt;();</span>
<span class="fc" id="L592">        allJavascripts.stream().map(js -&gt; new Script(js)).forEach(s</span>
                -&gt;
        {
<span class="fc" id="L595">            s.setNewLineForClosingTag(false);</span>
<span class="fc" id="L596">            allScripts.add(s);</span>
<span class="fc" id="L597">        });</span>
<span class="fc" id="L598">        return allScripts;</span>
    }

    /**
     * Returns if the head object is empty
     *
     * @return
     */
    private boolean isHeadEmpty()
    {
<span class="fc" id="L608">        return getHead().getChildren().isEmpty();</span>
    }

    /**
     * Returns if the body object is empty
     *
     * @return
     */
    private boolean isBodyEmpty()
    {
<span class="fc" id="L618">        return getBody().getChildren().isEmpty();</span>
    }

    /**
     * Returns a readable user agent, or null if just a basic render
     *
     * @return
     */
    public ReadableUserAgent getUserAgent()
    {
<span class="nc bnc" id="L628" title="All 2 branches missed.">        if (userAgent == null)</span>
        {
<span class="nc" id="L630">            userAgent = new UserAgent(DeviceCategory.EMPTY, UserAgentFamily.FIREFOX, &quot;&quot;, &quot;&quot;, OperatingSystem.EMPTY, &quot;&quot;, &quot;&quot;, UserAgentType.BROWSER, &quot;&quot;, &quot;&quot;, VersionNumber.UNKNOWN);</span>
        }
<span class="nc" id="L632">        return userAgent;</span>
    }

    /**
     * Sets the userAgent
     *
     * @param userAgent
     */
    public void setUserAgent(ReadableUserAgent userAgent)
    {
<span class="nc" id="L642">        this.userAgent = userAgent;</span>
<span class="nc" id="L643">    }</span>

    /**
     * Returns all the dynamic options for a page
     *
     * @return
     */
    @Override
    public PageOptions getOptions()
    {
<span class="fc bfc" id="L653" title="All 2 branches covered.">        if (options == null)</span>
        {
<span class="fc" id="L655">            options = new PageOptions(this);</span>
        }
<span class="fc" id="L657">        return options;</span>
    }

    /**
     * Returns the fields available for entry on this page
     *
     * @return
     */
    @Override
    public final PageFields getPageFields()
    {
<span class="fc bfc" id="L668" title="All 2 branches covered.">        if (fields == null)</span>
        {
<span class="fc" id="L670">            fields = new PageFields(this);</span>
        }
<span class="fc" id="L672">        return fields;</span>
    }

    /**
     * Returns the document type that will be rendered with this HTML page real-time
     * &lt;p&gt;
     * @return Document Type
     */
    @Override
    public DocumentType getDocumentType()
    {
<span class="nc" id="L683">        return new DocumentType(getBrowser().getHtmlVersion());</span>
    }

    /**
     * Sets all component in the head and body to tiny
     *
     * @param tiny
     *
     * @return
     */
    @Override
    public Page setTiny(boolean tiny)
    {
<span class="fc" id="L696">        super.setTiny(tiny);</span>
<span class="fc" id="L697">        getHead().setTiny(tiny);</span>
<span class="fc" id="L698">        getBody().setTiny(tiny);</span>
<span class="fc" id="L699">        return this;</span>
    }

    /**
     * Returns the JavaScript render for the body
     *
     * @return
     */
    @Override
    public StringBuilder renderJavascript()
    {
<span class="fc" id="L710">        return getBody().renderJavascript();</span>
    }

    /**
     * Adds a variable into angular
     *
     * @param variableName
     *
     * @return
     */
    @Override
    public Page addAngularVariable(String variableName)
    {
<span class="fc" id="L723">        getAngular().getAngularVariables().add(variableName);</span>
<span class="fc" id="L724">        return this;</span>
    }

    /**
     * Returns the angular object
     *
     * @return
     */
    @Override
    public AngularFeature getAngular()
    {
<span class="fc bfc" id="L735" title="All 2 branches covered.">        if (angular == null)</span>
        {
<span class="fc" id="L737">            angular = new AngularFeature(getBody());</span>
<span class="fc" id="L738">            getBody().addFeature(angular);</span>
        }
<span class="fc" id="L740">        return angular;</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.6.201602180812</span></div></body></html>