<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>JQImageMap.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">JaCoCoverage analysis of project &quot;JWebSwing&quot; (powered by JaCoCo from EclEmma)</a> &gt; <a href="index.source.html" class="el_package">za.co.mmagon.jwebswing.components.jqimagemap.imagemap</a> &gt; <span class="el_source">JQImageMap.java</span></div><h1>JQImageMap.java</h1><pre class="source lang-java linenums">package za.co.mmagon.jwebswing.components.jqimagemap.imagemap;

import java.util.*;
import za.co.mmagon.jwebswing.*;
import za.co.mmagon.jwebswing.base.*;
import za.co.mmagon.jwebswing.base.html.Map;
import za.co.mmagon.jwebswing.base.html.*;
import za.co.mmagon.jwebswing.base.html.attributes.*;
import za.co.mmagon.jwebswing.base.html.interfaces.children.*;
import za.co.mmagon.jwebswing.base.html.interfaces.events.*;
import za.co.mmagon.jwebswing.base.servlets.enumarations.*;
import za.co.mmagon.jwebswing.components.jqueryui.position.*;
import za.co.mmagon.jwebswing.features.gradients.*;
import za.co.mmagon.jwebswing.htmlbuilder.css.displays.*;
import za.co.mmagon.jwebswing.htmlbuilder.javascript.*;

/**
 * The image map component
 *
 * @author mmagon
 * @since 2013/01/14
 * @version 0.1
 */
@DisplayCSS(Position = Positions.Relative)
public class JQImageMap extends Component&lt;ImageMapChildren, ImageMapAttributes, ImageMapFeatures, GlobalEvents, Component&gt; implements BodyChildren
{

    private Div labelsDiv;
    private Div legendDiv;
    private Map map;
    private Image image;
    private int imageXSize;
    private int imageYSize;
    private int displayXSize;
    private int displayYSize;
    private Div labelHeadDiv;

    /**
     * The default interactive feature
     */
<span class="nc" id="L41">    private JQMapInteractiveFeature defaultProperties = new JQMapInteractiveFeature(this);</span>
    /**
     * The default interactive feature
     */
<span class="nc" id="L45">    private final JQImageHeatMapFeature heatMap = new JQImageHeatMapFeature(this, 1, 1000000);</span>

<span class="nc" id="L47">    private final JWGradientsFeature gradientFeature = new JWGradientsFeature(this, this.heatMap.getColourMin(), this.heatMap.getColourMax(), &quot;vertical&quot;);</span>

<span class="nc" id="L49">    private final JQMapLegendFeature legendFeature = new JQMapLegendFeature(this, gradientFeature);</span>

    /**
     * The map URL
     */
    private String mapImageUrl;
    /**
     * Sets whether the image map should apply a heat map This attaches a heat map feature
     */
    private boolean heatmap;
    /**
     * Shows whether the map is interactive Allows for highlighting
     */
    private boolean interactive;
    /**
     * Shows whether the map is labeled This puts a div at the Center of each polygon
     */
    private boolean labeled;
    /**
     * Sets whether to display a legend or not
     */
    private boolean legend;

    private boolean valueDisplayed;

<span class="nc" id="L74">    private boolean ratioConfigured = false;</span>

    /**
     * Constructs a new Image Map
     *
     * @param mapImageUrl
     */
    public JQImageMap(String mapImageUrl)
    {
<span class="nc" id="L83">        this(mapImageUrl, false, false, false);</span>
<span class="nc" id="L84">        this.labelHeadDiv = new Div();</span>
<span class="nc" id="L85">    }</span>

    /**
     * Constructs an ImageMap from the given parameters with the testing sizes
     *
     * @param mapImageUrl
     * @param heatmap
     * @param interactive
     * @param labeled
     */
    public JQImageMap(String mapImageUrl, boolean heatmap, boolean interactive, boolean labeled)
    {
<span class="nc" id="L97">        this(mapImageUrl, heatmap, interactive, labeled, 0, 0, 0, 0);</span>
<span class="nc" id="L98">        this.labelHeadDiv = new Div();</span>
<span class="nc" id="L99">    }</span>

    /**
     *
     * @param mapImageUrl
     * @param heatmap
     * @param interactive
     * @param labeled
     * @param imageXSize   The original Image size
     * @param imageYSize   The original Image size
     * @param displayXSize The new image x size
     * @param displayYSize the new image y size
     */
    public JQImageMap(String mapImageUrl, boolean heatmap, boolean interactive, boolean labeled, int imageXSize, int imageYSize, int displayXSize, int displayYSize)
    {
<span class="nc" id="L114">        super(&quot;div&quot;, ComponentTypes.Div, false);</span>
<span class="nc" id="L115">        this.labelHeadDiv = new Div();</span>
<span class="nc" id="L116">        this.imageXSize = imageXSize;</span>
<span class="nc" id="L117">        this.imageYSize = imageYSize;</span>
<span class="nc" id="L118">        this.displayYSize = displayYSize;</span>
<span class="nc" id="L119">        this.displayXSize = displayXSize;</span>
<span class="nc" id="L120">        this.mapImageUrl = mapImageUrl;</span>
<span class="nc" id="L121">        this.heatmap = heatmap;</span>
<span class="nc" id="L122">        this.interactive = interactive;</span>
<span class="nc" id="L123">        this.labeled = labeled;</span>

<span class="nc" id="L125">        this.map = new Map();</span>
<span class="nc" id="L126">        this.image = new Image(this.mapImageUrl);</span>
<span class="nc" id="L127">        defaultProperties.setDefaultProperties(true);</span>
<span class="nc" id="L128">        image.addAttribute(ImageAttributes.UseMap, &quot;#&quot; + this.map.getID());</span>
<span class="nc" id="L129">        add(image);</span>
<span class="nc" id="L130">        add(map);</span>
<span class="nc" id="L131">    }</span>

    /**
     * Adds a specified area to the image map
     *
     * @param areaName           The name of the area
     * @param polygonCoordinates The co-ordinates for the area
     *
     * @return True or false if added public Area addAreaToMap(String areaName, String polygonCoordinates) { Area a = new Area(ImageMapAreaShapes.Poly, polygonCoordinates);
     *         a.addAttribute(GlobalAttributes.Name, areaName); this.map.add(a); return a; }
     */
    public Area addAreaToMap(String areaName, String polygonCoordinates)
    {
<span class="nc" id="L144">        Area a = new Area(ImageMapAreaShapes.Poly, polygonCoordinates);</span>
<span class="nc" id="L145">        a.addAttribute(GlobalAttributes.Name, areaName);</span>
<span class="nc" id="L146">        this.map.add(a);</span>
<span class="nc" id="L147">        return a;</span>
    }

    /**
     * Adds a specified area to the image map
     *
     * @param area The area to add
     *
     * @return Always True
     */
    public boolean addAreaToMap(Area area)
    {
<span class="nc" id="L159">        this.map.add(area);</span>
<span class="nc" id="L160">        return true;</span>
    }

    public Area add(Area area)
    {
<span class="nc" id="L165">        addAreaToMap(area);</span>
<span class="nc" id="L166">        return area;</span>
    }

    private void renderResize()
    {
<span class="nc bnc" id="L171" title="All 2 branches missed.">        if (displayXSize != 0)</span>
        {
<span class="nc" id="L173">            image.addAttribute(ImageAttributes.Width, displayXSize + &quot;px&quot;);</span>
<span class="nc" id="L174">            image.addAttribute(ImageAttributes.Height, displayYSize + &quot;px&quot;);</span>

<span class="nc" id="L176">            int ratioXDifference = (int) (new Double(displayXSize) / new Double(imageXSize));</span>
<span class="nc" id="L177">            int ratioYDifference = (int) (new Double(displayYSize) / new Double(imageYSize));</span>

            int[] xArray;
            int[] yArray;
<span class="nc bnc" id="L181" title="All 6 branches missed.">            if (!(ratioXDifference == 1 &amp;&amp; ratioYDifference == 1) &amp;&amp; !ratioConfigured)</span>
            {
<span class="nc" id="L183">                ratioConfigured = true;</span>
<span class="nc bnc" id="L184" title="All 2 branches missed.">                for (Iterator&lt;ComponentHierarchyBase&gt; it = this.map.getChildren().iterator(); it.hasNext();)</span>
                {
<span class="nc" id="L186">                    Area area = (Area) it.next();</span>
<span class="nc" id="L187">                    int[][] allPoints = area.getCoordinatesArray();</span>
<span class="nc" id="L188">                    xArray = new int[allPoints.length];</span>
<span class="nc" id="L189">                    yArray = new int[allPoints.length];</span>
<span class="nc" id="L190">                    int xTotal = 0;</span>
<span class="nc" id="L191">                    int yTotal = 0;</span>
<span class="nc bnc" id="L192" title="All 2 branches missed.">                    for (int i = 0; i &lt; allPoints.length; i++)</span>
                    {
<span class="nc" id="L194">                        int[] is = allPoints[i];</span>
<span class="nc" id="L195">                        xArray[i] = (int) (is[0] * ratioXDifference);</span>
<span class="nc" id="L196">                        xTotal += xArray[i];</span>
<span class="nc" id="L197">                        yArray[i] = (int) (is[1] * ratioYDifference);</span>
<span class="nc" id="L198">                        yTotal += yArray[i];</span>
                    }

<span class="nc" id="L201">                    String coords = &quot;&quot;;</span>
<span class="nc bnc" id="L202" title="All 2 branches missed.">                    for (int i = 0; i &lt; xArray.length; i++)</span>
                    {
<span class="nc" id="L204">                        int j = xArray[i];</span>
<span class="nc" id="L205">                        int k = yArray[i];</span>
<span class="nc" id="L206">                        coords += j + &quot;,&quot; + k + &quot;,&quot;;</span>
                    }
<span class="nc" id="L208">                    coords = coords.substring(0, (coords.length() - 1));</span>
<span class="nc" id="L209">                    area.setCoordinates(coords);</span>
<span class="nc" id="L210">                }</span>
            }
        }
<span class="nc" id="L213">    }</span>

    @Override
    public void preConfigure()
    {
<span class="nc bnc" id="L218" title="All 2 branches missed.">        if (isInteractive())</span>
        {
<span class="nc" id="L220">            addFeature(defaultProperties);</span>
        }

<span class="nc bnc" id="L223" title="All 2 branches missed.">        if (isHeatmap())</span>
        {
<span class="nc" id="L225">            addFeature(defaultProperties);</span>
<span class="nc" id="L226">            addFeature(heatMap);</span>
<span class="nc bnc" id="L227" title="All 2 branches missed.">            if (isLegend())</span>
            {
<span class="nc" id="L229">                gradientFeature.setFromColour(this.heatMap.getColourMin());</span>
<span class="nc" id="L230">                gradientFeature.setToColour(this.heatMap.getColourMax());</span>
<span class="nc" id="L231">                gradientFeature.setDirection(&quot;vertical&quot;);</span>
<span class="nc" id="L232">                addFeature(legendFeature);</span>
<span class="nc" id="L233">                addFeature(gradientFeature);</span>
<span class="nc bnc" id="L234" title="All 2 branches missed.">                if (!getChildren().contains(legendFeature.getLayoutDiv()))</span>
                {
<span class="nc" id="L236">                    getChildren().add(getChildren().size(), legendFeature.getLayoutDiv());</span>
                }
            }

<span class="nc" id="L240">            double totalValue = 0.0;</span>
<span class="nc" id="L241">            ArrayList&lt;Double&gt; values = new ArrayList();</span>
<span class="nc bnc" id="L242" title="All 2 branches missed.">            for (Iterator&lt;ComponentHierarchyBase&gt; it = this.map.getChildren().iterator(); it.hasNext();)</span>
            {
<span class="nc" id="L244">                Area area = (Area) it.next();</span>
<span class="nc" id="L245">                totalValue += area.getValue();</span>
<span class="nc" id="L246">                values.add(area.getValue());</span>
<span class="nc" id="L247">            }</span>
<span class="nc" id="L248">            heatMap.setValues(values);</span>
<span class="nc bnc" id="L249" title="All 2 branches missed.">            for (Iterator&lt;ComponentHierarchyBase&gt; it = this.map.getChildren().iterator(); it.hasNext();)</span>
            {
<span class="nc" id="L251">                Area area = (Area) it.next();</span>
<span class="nc" id="L252">                area.getInteractiveProperties().addProperty(JQMapInteractiveFeature.InteractiveFeatureProperties.overlayColorPermanent, heatMap.getColourForValue(area.getValue()));</span>
<span class="nc" id="L253">            }</span>
        }

<span class="nc bnc" id="L256" title="All 4 branches missed.">        if (isLabeled() || isValueDisplayed())</span>
        {
<span class="nc bnc" id="L258" title="All 2 branches missed.">            if (!(getChildren().contains(labelHeadDiv)))</span>
            {
<span class="nc" id="L260">                ArrayList&lt;ComponentHierarchyBase&gt; alreadyAdded = new ArrayList();</span>
<span class="nc bnc" id="L261" title="All 2 branches missed.">                for (Iterator&lt;ComponentHierarchyBase&gt; it = this.map.getChildren().iterator(); it.hasNext();)</span>
                {
<span class="nc" id="L263">                    Area area = (Area) it.next();</span>
<span class="nc bnc" id="L264" title="All 2 branches missed.">                    if (alreadyAdded.contains(area))</span>
                    {
<span class="nc" id="L266">                        continue;</span>
                    }
<span class="nc" id="L268">                    alreadyAdded.add(area);</span>
<span class="nc" id="L269">                    Span areaLableDiv = new Span();</span>
                    //areaLableDiv.getCss().getDisplay().setPosition(Positions.Absolute);
<span class="nc" id="L271">                    areaLableDiv.setText(&quot;&quot;);</span>
<span class="nc" id="L272">                    areaLableDiv.addAttribute(GlobalAttributes.Style, &quot;color:#000000 !important&quot;);</span>
<span class="nc bnc" id="L273" title="All 2 branches missed.">                    if (isLabeled())</span>
                    {
<span class="nc" id="L275">                        areaLableDiv.setText(area.getAttribute(GlobalAttributes.Name));</span>
                    }
<span class="nc bnc" id="L277" title="All 2 branches missed.">                    if (isValueDisplayed())</span>
                    {
<span class="nc" id="L279">                        areaLableDiv.setText(areaLableDiv.getText(0) + &quot;&lt;br&gt;&quot; + area.getPrettyValue());</span>
                    }

                    class Binder extends Feature&lt;JavaScriptPart, Binder&gt;
                    {

                        private static final long serialVersionUID = 1L;

                        Span label;
                        Area area;

                        public Binder(Span label, Area area)
<span class="nc" id="L291">                        {</span>
<span class="nc" id="L292">                            super(&quot;Image Map Label Binder&quot;);</span>
<span class="nc" id="L293">                            this.label = label;</span>
<span class="nc" id="L294">                            this.area = area;</span>
<span class="nc" id="L295">                        }</span>

                        @Override
                        public void assignFunctionsToComponent()
                        {

<span class="nc" id="L301">                            addQuery(&quot;$('#&quot; + label.getID() + &quot;').bind('click', function(event) {$('#&quot; + area.getID() + &quot;').click();});&quot;);</span>
<span class="nc" id="L302">                            addQuery(&quot;$('#&quot; + label.getID() + &quot;').bind('hover', function(event) {$('#&quot; + area.getID() + &quot;').hover();});&quot;);</span>
<span class="nc" id="L303">                            addQuery(&quot;$('#&quot; + label.getID() + &quot;').bind('mouseover', function(event) {$('#&quot; + area.getID() + &quot;').mouseover();});&quot;);</span>
<span class="nc" id="L304">                            addQuery(&quot;$('#&quot; + label.getID() + &quot;').bind('mouseout', function(event) {$('#&quot; + area.getID() + &quot;').mouseout();});&quot;);</span>
<span class="nc" id="L305">                        }</span>
                    }

<span class="nc" id="L308">                    areaLableDiv.addAttribute(GlobalAttributes.Style, &quot;position:absolute&quot;);</span>
<span class="nc" id="L309">                    areaLableDiv.addFeature(new Binder(areaLableDiv, area));</span>
                    //int[] Center = PolygonUtils.getCenterPointOfPolygon(area.getCoordinates());
                    //areaLableDiv.addAttribute(GlobalAttributes.Style, &quot;position:absolute;top:&quot; + Center[0] + &quot;;Left:&quot;+ Center[1]);
<span class="nc" id="L312">                    areaLableDiv.addFeature(new JQUIPositionFeature(areaLableDiv, new Position(PositionLocationHorizontal.Center, PositionLocationVertical.center, PositionLocationHorizontal.Center, PositionLocationVertical.center, area)));</span>
<span class="nc" id="L313">                    area.add(areaLableDiv);</span>
                    //add(areaLableDiv);
<span class="nc" id="L315">                }</span>
                //add(labelHeadDiv);
            }
        }

<span class="nc bnc" id="L320" title="All 2 branches missed.">        for (Iterator&lt;ComponentHierarchyBase&gt; it = this.map.getChildren().iterator(); it.hasNext();)</span>
        {
<span class="nc" id="L322">            Area area = (Area) it.next();</span>
<span class="nc" id="L323">            area.addAttribute(AreaAttributes.Data_MapHilight, &quot;{&quot; + area.getInteractiveProperties().getProperties(true) + &quot;}&quot;);</span>
<span class="nc" id="L324">        }</span>
        //setPosition(Positions.Absolute);
<span class="nc" id="L326">        super.preConfigure();</span>
<span class="nc" id="L327">    }</span>

    /**
     * Returns the default properties
     *
     * @return
     */
    public JQMapInteractiveFeature getDefaultProperties()
    {
<span class="nc" id="L336">        return defaultProperties;</span>
    }

    /**
     * Sets the default properties
     *
     * @param defaultProperties
     */
    public void setDefaultProperties(JQMapInteractiveFeature defaultProperties)
    {
<span class="nc" id="L346">        this.defaultProperties = defaultProperties;</span>
<span class="nc" id="L347">    }</span>

    /**
     * Return the current map object
     *
     * @return
     */
    public Map getMap()
    {
<span class="nc" id="L356">        return map;</span>
    }

    /**
     * Sets the current map object
     *
     * @param map
     */
    public void setMap(Map map)
    {
<span class="nc" id="L366">        this.map = map;</span>
<span class="nc" id="L367">    }</span>

    /**
     * Returns the associated image
     *
     * @return
     */
    public Image getImage()
    {
<span class="nc" id="L376">        return image;</span>
    }

    /**
     * Sets the associated image
     *
     * @param image
     */
    public void setImage(Image image)
    {
<span class="nc" id="L386">        this.image = image;</span>
<span class="nc" id="L387">    }</span>

    /**
     * Returns the Map Image URL
     *
     * @return
     */
    public String getMapImageUrl()
    {
<span class="nc" id="L396">        return mapImageUrl;</span>
    }

    /**
     * Sets the map image url
     *
     * @param mapImageUrl
     */
    public void setMapImageUrl(String mapImageUrl)
    {
<span class="nc" id="L406">        this.mapImageUrl = mapImageUrl;</span>
<span class="nc" id="L407">    }</span>

    /**
     * If this map is a heat map
     *
     * @return
     */
    public boolean isHeatmap()
    {
<span class="nc" id="L416">        return heatmap;</span>
    }

    /**
     * If this map is a heatmap
     *
     * @param heatmap
     */
    public void setHeatmap(boolean heatmap)
    {
<span class="nc" id="L426">        this.heatmap = heatmap;</span>
<span class="nc" id="L427">    }</span>

    /**
     * If this map is interactive
     *
     * @return
     */
    public boolean isInteractive()
    {
<span class="nc" id="L436">        return interactive;</span>
    }

    /**
     * If this map has a legend
     *
     * @return
     */
    public boolean isLegend()
    {
<span class="nc" id="L446">        return legend;</span>
    }

    /**
     * If this map has a legend
     *
     * @param legend
     */
    public void setLegend(boolean legend)
    {
<span class="nc" id="L456">        this.legend = legend;</span>
<span class="nc" id="L457">    }</span>

    /**
     * If this map is interactive
     *
     * @param interactive
     */
    public void setInteractive(boolean interactive)
    {
<span class="nc" id="L466">        this.interactive = interactive;</span>
<span class="nc bnc" id="L467" title="All 2 branches missed.">        if (isInteractive())</span>
        {
<span class="nc" id="L469">            addFeature(defaultProperties);</span>
        }
        else
        {
<span class="nc" id="L473">            removeFeature(defaultProperties);</span>
        }
<span class="nc" id="L475">    }</span>

    /**
     * Image x size
     *
     * @return
     */
    public int getImageXSize()
    {
<span class="nc" id="L484">        return imageXSize;</span>
    }

    /**
     * Image x size
     *
     * @param imageXSize
     */
    public void setImageXSize(int imageXSize)
    {
<span class="nc" id="L494">        this.imageXSize = imageXSize;</span>
<span class="nc" id="L495">    }</span>

    /**
     * Image Y size
     *
     * @return
     */
    public int getImageYSize()
    {
<span class="nc" id="L504">        return imageYSize;</span>
    }

    /**
     * Is value displayed
     *
     * @return
     */
    public boolean isValueDisplayed()
    {
<span class="nc" id="L514">        return valueDisplayed;</span>
    }

    /**
     * Is value displayed
     *
     * @param valueDisplayed
     */
    public void setValueDisplayed(boolean valueDisplayed)
    {
<span class="nc" id="L524">        this.valueDisplayed = valueDisplayed;</span>
<span class="nc" id="L525">    }</span>

    /**
     * Set image y size
     *
     * @param imageYSize
     */
    public void setImageYSize(int imageYSize)
    {
<span class="nc" id="L534">        this.imageYSize = imageYSize;</span>
<span class="nc" id="L535">    }</span>

    /**
     * getDisplay X Size
     *
     * @return
     */
    public int getDisplayXSize()
    {
<span class="nc" id="L544">        return displayXSize;</span>
    }

    /**
     * getDisplay X size
     *
     * @param displayXSize
     */
    public void setDisplayXSize(int displayXSize)
    {
<span class="nc" id="L554">        this.displayXSize = displayXSize;</span>
<span class="nc" id="L555">    }</span>

    /**
     * getDisplay Y size
     *
     * @return
     */
    public int getDisplayYSize()
    {
<span class="nc" id="L564">        return displayYSize;</span>
    }

    /**
     * getDisplay Y size
     *
     * @param displayYSize
     */
    public void setDisplayYSize(int displayYSize)
    {
<span class="nc" id="L574">        this.displayYSize = displayYSize;</span>
<span class="nc" id="L575">    }</span>

    /**
     * Set is labeled
     *
     * @return
     */
    public boolean isLabeled()
    {
<span class="nc" id="L584">        return labeled;</span>
    }

    /**
     * Set is labeled
     *
     * @param labeled
     */
    public void setLabeled(boolean labeled)
    {
<span class="nc" id="L594">        this.labeled = labeled;</span>
<span class="nc" id="L595">    }</span>

    /**
     * Return the heat map options
     *
     * @return
     */
    public JQImageHeatMapFeature getHeatMap()
    {
<span class="nc" id="L604">        return heatMap;</span>
    }

    /**
     * Available image area shapes
     */
<span class="pc" id="L610">    public enum ImageMapAreaShapes</span>
    {
<span class="fc" id="L612">        Default,</span>
<span class="fc" id="L613">        Rect,</span>
<span class="fc" id="L614">        Circle,</span>
<span class="fc" id="L615">        Poly;</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.6.201602180812</span></div></body></html>